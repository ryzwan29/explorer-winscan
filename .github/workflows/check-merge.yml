name: Check Merge Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-merge:
    runs-on: ubuntu-latest
    name: Check for merge conflicts
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for merge conflicts
        run: |
          echo "üîç Checking for merge conflicts..."
          
          # Fetch all branches
          git fetch origin
          
          # Check if there are any merge conflicts
          if git merge-tree $(git merge-base HEAD origin/main) HEAD origin/main | grep -q '<<<<<'; then
            echo "‚ùå Merge conflicts detected!"
            echo "::error::This PR has merge conflicts with main branch. Please resolve conflicts before merging."
            exit 1
          else
            echo "‚úÖ No merge conflicts detected"
          fi
      
      - name: Check for merge issues (dry run)
        run: |
          echo "üß™ Testing merge (dry run)..."
          
          # Try to merge without actually merging
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Create a temporary branch for testing
          git checkout -b test-merge
          
          # Try to merge main into test branch
          if git merge origin/main --no-commit --no-ff; then
            echo "‚úÖ Merge test successful - no conflicts"
            # Only abort if there's an actual merge in progress
            if [ -f .git/MERGE_HEAD ]; then
              git merge --abort
            fi
          else
            echo "‚ùå Merge test failed - conflicts detected"
            # Only abort if there's an actual merge in progress
            if [ -f .git/MERGE_HEAD ]; then
              git merge --abort
            fi
            exit 1
          fi

  build-test:
    runs-on: ubuntu-latest
    name: Build and test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run build
        run: npm run build
      
      - name: Check for build errors
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ Build successful"
          else
            echo "‚ùå Build failed"
            exit 1
          fi

  lint-check:
    runs-on: ubuntu-latest
    name: Lint and type check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
        continue-on-error: true
      
      - name: Type check
        run: npx tsc --noEmit
        continue-on-error: true

  status-check:
    runs-on: ubuntu-latest
    name: Overall Status
    needs: [check-merge, build-test, lint-check]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          echo "üìä Checking overall status..."
          
          if [ "${{ needs.check-merge.result }}" != "success" ]; then
            echo "‚ùå Merge check failed"
            exit 1
          fi
          
          if [ "${{ needs.build-test.result }}" != "success" ]; then
            echo "‚ùå Build test failed"
            exit 1
          fi
          
          echo "‚úÖ All checks passed!"
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.check-merge.result }}' === 'success' && 
                          '${{ needs.build-test.result }}' === 'success';
            
            const body = status 
              ? '‚úÖ **All checks passed!**\n\n- No merge conflicts\n- Build successful\n- Ready for review'
              : '‚ùå **Some checks failed**\n\nPlease check the workflow logs for details.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
